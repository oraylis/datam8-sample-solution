{%- macro ddl_column_declaration(model, attributes) -%}
    -- Table columns
    {%- for column in attributes %}
        {%- set data_type = model.data_types.get_data_type(column.dataType) %}
        {%- set precision_scale = "" %}
        {%- set nullability = "" if column.nullable else " NOT NULL" %}
        {%- if data_type.hasPrecision %}
            {%- set precision_scale = "(%s" % (38 if column.precision is none else column.precision) %}
            {%- if data_type.hasScale %}
                {%- set precision_scale = precision_scale + ", %s" % (18 if column.scale is none else column.scale) %}
            {% endif %}
            {%- set precision_scale = precision_scale + ")" %}
        {% endif %}
        {%- set prefix = "," if not loop.first %}
        {%- set column_name = "`%s`" % column.name %}
        {%- set type = data_type.parquetType + precision_scale %}
        {%- if "SK" == column.history.value %}
            {%- set comment = "COMMENT 'SK' GENERATED BY DEFAULT AS IDENTITY" %}
        {%- elif "BK" == column.history.value and column.businessKeyNo %}
            {%- set comment = "COMMENT 'BK'" %}
        {%- elif "SCD0" == column.history.value %}
            {%- set comment = "COMMENT 'SCD0'" %}
        {%- elif "SCD1" == column.history.value %}
            {%- set comment = "COMMENT 'SCD1'" %}
        {%- elif "SCD2" == column.history.value %}
            {%- set comment = "COMMENT 'SCD2'" %}
        {%- endif %}
{{ "%-4s%-30s %-10s %-10s %-10s" | format(prefix, column_name, type, nullability, comment) }}
    {%- endfor %}

    -- Technical columns
,   `__SourceTable_BK`             string      NOT NULL
{%- set scd2_ns = namespace(first=true) %}
{%- for column in attributes %}
  {%- if "SCD2" == column.history.value and scd2_ns.first %}
    {%- set scd2_ns.first = false %}
,   `__ValidFrom`                  timestamp   NOT NULL  COMMENT 'SCD2 start date'
,   `__ValidTo`                    timestamp   NOT NULL  COMMENT 'SCD2 end date'
  {%- endif %}
{%- endfor %}
,   `__InsertTimestampUTC`         timestamp   NOT NULL
,   `__UpdateTimestampUTC`         timestamp   NOT NULL
,   `__InsertTimestampStageUTC`    timestamp   NOT NULL
{%- endmacro %}

{%- macro ddl_struct_type(model, attributes) -%}
# DBTITLE 1, Define schema
schema = StructType([
{%- for column in attributes -%}
    {%- set data_type = model.data_types.get_data_type(column.dataType) -%}
    {%- set parquet_type = data_type.parquetType %}
    {%- set type_details = "" %}
    {%- set precision = "" %}
    {%- set scale = "" %}
    {%- if data_type.hasPrecision %}
        {%- set precision = 38 if column.precision is none else column.precision %}
        {%- if data_type.hasScale %}
            {%- set scale = ",%s" % (18 if column.scale is none else column.scale) %}
        {%- endif -%}
        {%- set type_details = "(%s%s)" % (precision, scale) %}
    {%- endif -%}
    {%- set type = parquet_type + type_details %}
    StructField("{{ column.name }}", StructType.fromDDL("{{ type }}"), {{ column.nullable if column.nullable is not none else False }}),
{%- endfor %}
    StructField('__SourceTable_BK', StringType(), False), 
{%- set scd2_ns = namespace(first=true) -%}
{% for column in attributes %}
    {%- if "SCD2" == column.history.value and scd2_ns.first %}
        {%- set scd2_ns.first = false %}
        StructField("__ValidFrom", TimestampType(), False, metadata={"comment": "SCD2 start date"}),
        StructField("__ValidTo", TimestampType(), False, metadata={"comment": "SCD2 end date"}),
    {%- endif -%}
{%- endfor %}
    StructField('__InsertTimestampUTC', TimestampType(), False),
    StructField('__UpdateTimestampUTC', TimestampType(), False), 
    StructField('__InsertTimestampStageUTC', TimestampType(), False)
    ])
{%- endmacro %}
